<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>&#x7b80;&#x4ecb;</title>
        <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

/* From extension cnblogs.vscode-cnb */
:root{--highlighted-line-bg:#d1e3c9;--highlighted-line-bg-dark:#264b33}.prismjs-engine pre[class*=language-],.prismjs-engine pre[class*=language-].line-numbers{white-space:normal}.prismjs-engine pre[class*=language-] code,.prismjs-engine pre[class*=language-].line-numbers code{display:block;white-space:pre}.hljs-engine pre[class*=language-],.hljs-engine pre[class*=language-].line-numbers{white-space:normal}.hljs-engine pre[class*=language-] code,.hljs-engine pre[class*=language-].line-numbers code{white-space:pre}.hljs-engine .hljs .hljs-ln-numbers{color:#bfbfbf;padding:0 14px}pre.hljs-lines-highlighted{--spacing-left:14px;--spacing-right:14px}pre.hljs-lines-highlighted :after,pre.hljs-lines-highlighted :before{box-sizing:border-box}pre.hljs-lines-highlighted,pre.hljs-lines-highlighted[class*=language-]{padding-left:0;padding-right:0}pre.hljs-lines-highlighted code.hljs[data-lines-highlight],pre.hljs-lines-highlighted code[data-lines-highlight]{padding-left:var(--spacing-left);padding-right:var(--spacing-right);position:relative}pre.hljs-lines-highlighted code.hljs[data-lines-highlight].hljs-line-numbers,pre.hljs-lines-highlighted code[data-lines-highlight].hljs-line-numbers{padding-left:0}pre.hljs-lines-highlighted code.hljs[data-lines-highlight][data-dark-theme],pre.hljs-lines-highlighted code[data-lines-highlight][data-dark-theme]{--highlighted-line-bg:var(--highlighted-line-bg-dark)}pre.hljs-lines-highlighted code.hljs[data-lines-highlight] table.hljs-ln,pre.hljs-lines-highlighted code[data-lines-highlight] table.hljs-ln{margin:0;width:100%}pre.hljs-lines-highlighted code.hljs[data-lines-highlight] table.hljs-ln tbody,pre.hljs-lines-highlighted code[data-lines-highlight] table.hljs-ln tbody{width:100%}pre.hljs-lines-highlighted code.hljs[data-lines-highlight] table.hljs-ln tr:before,pre.hljs-lines-highlighted code[data-lines-highlight] table.hljs-ln tr:before{content:" ";position:absolute}pre.hljs-lines-highlighted code.hljs[data-lines-highlight] table.hljs-ln tr:after,pre.hljs-lines-highlighted code[data-lines-highlight] table.hljs-ln tr:after{content:" ";display:block;margin-right:calc(var(--spacing-right)*-1)}pre.hljs-lines-highlighted code.hljs[data-lines-highlight] table.hljs-ln tr.highlighted-line,pre.hljs-lines-highlighted code[data-lines-highlight] table.hljs-ln tr.highlighted-line{background:var(--highlighted-line-bg);position:relative}pre.hljs-lines-highlighted code.hljs[data-lines-highlight] table.hljs-ln tr.highlighted-line td.hljs-ln-line.hljs-ln-numbers,pre.hljs-lines-highlighted code[data-lines-highlight] table.hljs-ln tr.highlighted-line td.hljs-ln-line.hljs-ln-numbers{background:var(--highlighted-line-bg)}pre.hljs-lines-highlighted code.hljs[data-lines-highlight] table.hljs-ln tr.highlighted-line:before,pre.hljs-lines-highlighted code[data-lines-highlight] table.hljs-ln tr.highlighted-line:before{background:var(--highlighted-line-bg);content:"+";display:inline-block;left:4px;position:absolute;z-index:1}pre.hljs-lines-highlighted code.hljs[data-lines-highlight] table.hljs-ln tr.highlighted-line:after,pre.hljs-lines-highlighted code[data-lines-highlight] table.hljs-ln tr.highlighted-line:after{background:var(--highlighted-line-bg)}pre.hljs-lines-highlighted code.hljs[data-lines-highlight] table.hljs-ln tr td.hljs-ln-line.hljs-ln-numbers,pre.hljs-lines-highlighted code[data-lines-highlight] table.hljs-ln tr td.hljs-ln-line.hljs-ln-numbers{padding-left:calc(var(--spacing-left) + 4px);padding-right:calc(var(--spacing-left) + 4px);width:1px}pre.hljs-lines-highlighted code.hljs[data-lines-highlight] table.hljs-ln tr td.hljs-ln-line.hljs-ln-code,pre.hljs-lines-highlighted code[data-lines-highlight] table.hljs-ln tr td.hljs-ln-line.hljs-ln-code{width:100%}pre.hljs-lines-highlighted code.hljs[data-lines-highlight]:not(.hljs-line-numbers) span.hljs-lines-highlight-wrapper,pre.hljs-lines-highlighted code[data-lines-highlight]:not(.hljs-line-numbers) span.hljs-lines-highlight-wrapper{display:inline-block;min-width:100%}pre.hljs-lines-highlighted code.hljs[data-lines-highlight]:not(.hljs-line-numbers) span.hljs-lines-highlight-wrapper span.highlighted-line,pre.hljs-lines-highlighted code[data-lines-highlight]:not(.hljs-line-numbers) span.hljs-lines-highlight-wrapper span.highlighted-line{background:var(--highlighted-line-bg);display:inline-block;min-width:100%;position:relative}pre.hljs-lines-highlighted code.hljs[data-lines-highlight]:not(.hljs-line-numbers) span.hljs-lines-highlight-wrapper span.highlighted-line:before,pre.hljs-lines-highlighted code[data-lines-highlight]:not(.hljs-line-numbers) span.hljs-lines-highlight-wrapper span.highlighted-line:before{background:var(--highlighted-line-bg);bottom:0;content:"+";left:calc(var(--spacing-left)*-1);padding-left:calc((var(--spacing-left) - .5px)/3);position:absolute;top:0;width:var(--spacing-left)}pre.hljs-lines-highlighted code.hljs[data-lines-highlight]:not(.hljs-line-numbers) span.hljs-lines-highlight-wrapper span.highlighted-line:after,pre.hljs-lines-highlighted code[data-lines-highlight]:not(.hljs-line-numbers) span.hljs-lines-highlight-wrapper span.highlighted-line:after{background:var(--highlighted-line-bg);bottom:0;content:"";left:calc(var(--spacing-left)*-1);left:auto;padding-left:0;position:absolute;right:calc(var(--spacing-right)*-1);top:0;width:var(--spacing-left)}pre.prismjs-lines-highlighted{--spacing-right:1em}pre.prismjs-lines-highlighted :after,pre.prismjs-lines-highlighted :before{box-sizing:border-box}pre.prismjs-lines-highlighted,pre.prismjs-lines-highlighted.line-numbers,pre.prismjs-lines-highlighted[class*=language-]{padding-left:var(--spacing-left);padding-right:var(--spacing-right)}pre.prismjs-lines-highlighted[class*=language-]:not(.line-numbers){--spacing-left:1em}pre.prismjs-lines-highlighted[class*=language-].line-numbers{--spacing-left:3.8em}pre.prismjs-lines-highlighted code.highlighter-prismjs[data-lines-highlight]{display:inline-block;min-width:100%;position:relative}pre.prismjs-lines-highlighted code.highlighter-prismjs[data-lines-highlight][data-dark-theme]{--highlighted-line-bg:var(--highlighted-line-bg-dark)}pre.prismjs-lines-highlighted code.highlighter-prismjs[data-lines-highlight] span.highlighted-line{background:var(--highlighted-line-bg);display:inline-block;min-width:100%;position:relative}pre.prismjs-lines-highlighted code.highlighter-prismjs[data-lines-highlight] span.highlighted-line:after,pre.prismjs-lines-highlighted code.highlighter-prismjs[data-lines-highlight] span.highlighted-line:before{background:var(--highlighted-line-bg);content:" ";display:inline-block;position:absolute}pre.prismjs-lines-highlighted code.highlighter-prismjs[data-lines-highlight] span.highlighted-line:before{content:"+";left:calc(var(--spacing-left)*-1);padding-left:4px;width:var(--spacing-left)}pre.prismjs-lines-highlighted code.highlighter-prismjs[data-lines-highlight] span.highlighted-line:after{position:absolute;right:calc(var(--spacing-right)*-1);width:var(--spacing-right)}pre.prismjs-lines-highlighted .line-numbers-rows span{padding-right:0}
</style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
        
    </head>
    <body class="vscode-body vscode-light">
        <ul>
<li><a href="#%E7%AE%80%E4%BB%8B">简介</a>
<ul>
<li><a href="#prompt%E8%AE%BE%E8%AE%A1">Prompt设计</a>
<ul>
<li><a href="#hand-crafted-prompt">hand-crafted prompt</a></li>
<li><a href="#continuous-prompt">Continuous prompt</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE">参考文献</a></li>
</ul>
</li>
</ul>
<p>在最开始，介绍两个长期跟踪prompt工作的网站：</p>
<ul>
<li><a href="https://github.com/thunlp/PromptPapers">github prompt paper</a></li>
<li><a href="http://pretrain.nlpedia.ai/">pretrain prompt predict</a></li>
</ul>
<h1 id="简介">简介</h1>
<p>深度学习中的Prompt：引领NLP的第四范式</p>
<p>自2021年大模型的兴起以来，prompt作为一种重要的模型输入调整手段，逐渐得到了广泛的关注和研究。在刘鹏飞的关于NLP prompt的综述[^1]中，甚至将其视为NLP领域的第四范式，标志着其在自然语言处理中的重要性。随着大模型的不断进展，对于大模型中prompt的研究也在不断地深入，推动着NLP领域的发展。</p>
<p><img src="https://img2023.cnblogs.com/blog/3183309/202309/3183309-20230920114114973-2047020025.png" alt="trend"></p>
<p>Prompt与Fine-tune的共同目标在于将预训练模型和下游任务（在计算机视觉领域，如目标检测、图像生成等）的输入输出尽可能地相近。回顾一下Fine-tune的做法，通常需要在一个在ImageNet-1k上验证过的模型骨架（backbone）上添加一系列组件，例如RPN网络和ROIHead，最后再加入一个分类器。此外，Fine-tune会对该骨干模型进行一些<code>loss func</code>和<code>optimizer</code>的调整，以及引入下游任务的一些先验信息（例如，目标检测需要引入检测框的位置信息）。然而，在Fine-tune过程中，通常不会对输入数据进行太多修改，而是希望通过训练使骨干模型能够蕴含更多有关下游任务的信息。</p>
<p>与此相反，Prompt的核心在于修改输入数据，以使下游任务的输入和输出更贴近骨干模型，而不是为骨干模型提供更多下游信息的知识。因此，使用Prompt的前提是模型必须具备充足的相关知识，以便接受修改下游任务输入和输出的操作，以与模型相匹配。根据综述[^1]的定义，Prompt的主要构成包括：</p>
<ol>
<li><strong>Prompt Engineering</strong>：定义一个函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>m</mi><mi>p</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">f_{prompt}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">pt</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>，将下游任务的输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 转化为骨干模型的输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">x&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>。</li>
<li><strong>选择合适的模型骨干</strong>：确定适合的模型骨干，并将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">x&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> 输入该骨干以获取输出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>。</li>
<li><strong>Answer Engineering</strong>：定义一个函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>p</mi><mi>r</mi><mi>o</mi><mi>m</mi><mi>p</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">g_{prompt}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">pt</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>，将骨干模型的输出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> 转化为下游任务的输出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">y&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>。</li>
</ol>
<p>多模态任务中的prompt学习是一种利用预训练模型的语义表示能力，通过构造合适的输入文本和输出文本，来完成不同下游任务的方法。这种方法不需要对预训练模型进行大规模的微调，而是通过简单而有效的文本提示，来激活预训练模型中与目标任务相关的知识和能力。多模态任务中的prompt学习主要涉及以下几个方面：</p>
<ol>
<li>
<p>预训练模型的选择。预训练模型是prompt学习的基础，不同的预训练模型具有不同的特点和优势。目前，多模态领域中常用的预训练模型可以分为两类：</p>
<ul>
<li>判别式的预训练模型，如CLIP，它使用对比学习的方式，在大规模的图像-文本对上进行预训练，学习图像和文本之间的语义对齐。这类模型适合于处理分类、检索等判别性任务，如果需要用在生成方面需要额外添加decoder模型并进行训练。</li>
<li>生成式的预训练模型，如VLP，它使用遮盖语言建模（MLM）和图像-文本匹配（ITM）的方式，在大规模的图像-文本对上进行预训练，学习图像和文本之间的语义关联。这类模型适合于处理描述、问答等生成性任务，但对比能力较差。</li>
</ul>
</li>
<li>
<p>Prompt Engineering，即prompt的设计。prompt是指输入到预训练模型中的文本部分，它通常包含一个或多个遮盖符号（mask），用于提示预训练模型在给定图像或文本条件下，生成或预测与目标任务相关的输出。prompt的设计方法可以分为以下几种：</p>
<ul>
<li>Hand-crafted，即手工设计。这种方法根据每个特定下游任务的特点和需求，人为地构造一个固定的文本模板，作为输入到预训练模型中的prompt。这种方法简单直观，但需要专业知识和经验，并且缺乏泛化能力。</li>
<li>Discrete，即离散化。这种方法将输入映射到一个离散的空间中，例如使用词嵌入或字符嵌入来表示输入。这种方法可以增加prompt的可解释性和灵活性，但也增加了优化难度和计算开销，并且在自然语言处理（NLP）领域已经被证明表现不如其他方法。</li>
<li>Continuous，即连续化。这种方法将输入映射到一个连续的空间中，例如使用向量或张量来表示输入。这种方法可以充分利用预训练模型的语义表示能力，并且不需要为每个下游任务设计一个固定的文本模板。但是，这种方法也存在一些挑战，例如如何设计一个具有强泛化能力和鲁棒性的连续prompt。</li>
</ul>
</li>
<li>
<p>Answer Engineering，即输出重构。输出重构是指将预训练模型生成或预测出来的输出文本，转换成与下游任务相符合的形式。例如，在分类任务中，输出重构可以将输出文本映射到类别标签；在检索任务中，输出重构可以将输出文本转换成相似度得分；在生成任务中，输出重构可以将输出文本进行后处理或重排等操作。由于多模态领域中的大多数任务都可以很自然地使用文本标签来表示输出，因此关于输出重构的研究相对较少。</p>
</li>
<li>
<p>Multi-prompt，即多prompt融合。多prompt融合是指使用多个不同的prompt来处理同一个下游任务，并将它们的输出进行融合或集成，以提高最终的效果。这种方法可以利用不同prompt之间的互补性和多样性，增加模型的鲁棒性和泛化能力。目前，这个方向在多模态领域中的研究还比较少，需要进一步探索。</p>
</li>
<li>
<p>prompt范式下的训练策略。训练策略是指在使用prompt进行下游任务时，如何对预训练模型和prompt进行优化和调整。训练策略主要涉及以下几个方面：</p>
<ul>
<li>模型是否微调。由于多模态预训练模型通常具有很大的规模和复杂度，因此直接对整个模型进行微调是不可行或不经济的。因此，大部分prompt学习的方法都是不对预训练模型进行微调的，而是只对其中一部分进行修改或适应，例如图像编码器或文本解码器等。</li>
<li>prompt是否具备额外参数。一些prompt学习的方法会为prompt引入一些额外的参数，例如嵌入向量或权重矩阵等，以增加prompt的表达能力和灵活性。这些参数可以与预训练模型一起进行优化，也可以单独进行优化。</li>
<li>是否添加额外的网络架构。一些prompt学习的方法会在预训练模型的基础上，添加一些额外的网络架构，例如transformer或者decoder等，以增强预训练模型和prompt之间的交互和融合。这些网络架构可以作为一个中间层或一个输出层，也可以与预训练模型一起进行优化。</li>
</ul>
</li>
</ol>
<p>目前prompt的工作主要集中于NLP方面，特别是GPT一类的语言大模型（LLM）。针对多模态领域的prompt工作则相对较少，并且大部分工作尝试将NLP领域的一些trick迁移到多模态中来。并且多模态的prompt相关的论文还没有一个系统的综述，因此我大致按照时间顺序来对多模态的prompt进行介绍。</p>
<h2 id="prompt设计">Prompt设计</h2>
<h3 id="hand-crafted-prompt">hand-crafted prompt</h3>
<p>CLIP: Learning Transferable Visual Models From Natural Language Supervision,<a href="https://github.com/openai/CLIP">code</a></p>
<p>CLIP是一种利用对比学习的方式，在大规模的图像-文本对上进行预训练的模型，它可以学习图像和文本之间的语义对齐，并且具有很强的零样本学习能力。CLIP在使用预训练模型进行图像分类任务时，采用了一种基于prompt的方法，而不是传统的微调方法。具体来说，CLIP使用了以下几个步骤：</p>
<ol>
<li>对于每个待分类的图像，CLIP使用预训练的图像编码器（Image-Encoder）提取其特征向量。</li>
<li>对于每个可能的类别标签，CLIP构造一个固定的文本模板，形式为<code>A photo of X</code>，其中<code>X</code>是类别名称。例如，如果类别是猫，那么文本模板就是<code>A photo of a cat</code>。然后，CLIP使用预训练的文本编码器（Text-Encoder）提取其特征向量。</li>
<li>对于每个图像-文本对，CLIP计算它们之间的余弦相似度，作为它们之间的语义匹配程度。</li>
<li>对于每个待分类的图像，CLIP选择与其特征向量最相似的文本模板对应的类别标签，作为其分类结果。</li>
</ol>
<p><img src="https://img2023.cnblogs.com/blog/3183309/202309/3183309-20230919131922461-103141737.png" alt="CLIP"></p>
<p>这种基于prompt的方法与传统的微调方法有明显的区别。传统的微调方法通常需要在预训练模型的图像编码器后面添加一个全连接层（FC），作为分类器，并且在一些有标注数据的下游数据集上对FC层进行训练，然后用于分类任务。这种方法需要额外的数据和计算资源，并且可能导致预训练模型与下游任务之间的不匹配，并且往往会在zero-shot或者few-shot任务上导致过拟合现象。</p>
<p>而CLIP[^3]使用了一种简单而有效的prompt技巧，即<code>A photo of X</code>，来激活预训练模型中与目标任务相关的知识和能力，并且不需要对预训练模型进行任何修改或微调。这种方法可以充分利用预训练模型在大规模数据上学习到的通用和丰富的语义表示，并且具有很强的泛化能力和鲁棒性。实验结果也表明，这种基于prompt的方法在零样本学习场景下，可以显著优于传统的微调方法。</p>
<h3 id="continuous-prompt">Continuous prompt</h3>
<p><a href="https://github.com/KaiyangZhou/CoOp">CoOp Code</a>
<a href="https://github.com/thunderenlight/cocoop">CoCoOp Code</a>
<strong>分类</strong>：CoOp的作者在对CLIP的prompt进行实验的时候发现，对于同一张图片，不同的自然语言描述会导致不同的分类结果。例如一张猫的图片，可以有多种不同的prompt，如<code>a photo of cat</code>, <code>a cat</code>,<code>a class of cat</code>。这些prompt在CLIP中对应不同的类别向量，从而影响了分类性能。为了解决这个问题，CoOp提出了一种上下文优化（Context Optimization）的方法，将NLP中的连续prompt（continuous prompt）的方法引入到多模态的prompt中来，摒弃了为每个下游任务设计固定模板（template）的方法。</p>
<p><img src="https://img2023.cnblogs.com/blog/3183309/202309/3183309-20230920125639002-1721757103.png" alt="img"></p>
<p>如图所示，CoOp[^4]将每个类别对应的prompt分为两部分：一个是固定的上下文（context），一个是可学习的嵌入（embedding）。上下文是一个自然语言描述，用于输入的类别，例如<code>cat</code>。可学习的嵌入是一个可学习的参数。这两部分通过线性变换和归一化后拼接在一起，形成最终的prompt向量。CoOp通过优化一个对比损失函数（contrastive loss function），使得同类别的图片和prompt向量之间的相似度更高，而不同类别之间的相似度更低。</p>
<p>这篇论文还尝试了其他的嵌入类别信息的方式，例如将类别嵌入到可学习的上下文中，或者为每一个类别设计单独的可学习的上下文。最终得出结论，对于细粒度（fine-grained）的分类任务，单独设计上下文的效果更好，而对于粗粒度（coarse-grained）的分类任务，所有类别共享上下文的效果更好。</p>
<p>CoOp是第一篇将NLP中的prompt方法引入到多模态的prompt中来的论文。它采用的prompt方法也证实了prompt能够取得相比于预训练（pretrain）更好的性能。但它采用的手动设计上下文方法是很不严谨的，这也潜在地证明了prompt有更大的潜力。</p>
<p>CoCoOp[^6]是该团队在CoOp的基础上提出的一种条件式prompt（conditional prompt）的方法。CoOp在训练时只考虑了文本特征，而没有关注视觉特征，这就导致它在进行零样本（zero-shot）或者少样本（few-shot）任务时候过拟合。CoCoOp希望解决可学习向量在陌生类别上泛化能力弱（generalization ability）的问题。cocoop论文额外添加了一个元网络（meta-net），将图像编码器（image-encoder）产生的视觉特征通过元网络融合（直接相加）到可学习向量中。</p>
<p><img src="https://img2023.cnblogs.com/blog/3183309/202309/3183309-20230920162215580-2093714986.png" alt="img"></p>
<p>如图所示，元网络其实就是两层全连接层映射。添加元网络之后，CoCoOp在陌生类别上的效果比CoOp更好一些，但是基类上（base class）上的效果比CoOp要差一些。这说明CoCoOp解决了CoOp的过拟合问题，提高了prompt的泛化能力。但是，这个设置也降低了对于熟悉图像的处理能力，可能需要进一步的平衡。</p>
<p><a href="https://github.com/raoyongming/DenseCLIP">DenseCLIP Code</a></p>
<p><strong>Dense Prediction</strong>：DenseCLIP[^5]是一种将prompt的方法用于像素级别的密集预测任务上的框架。CLIP是一种利用对比学习的方法进行视觉-语言预训练的模型，但是CLIP的训练和预测都是在实例级别(instance-level)进行的，无法直接应用到像素级别(pixel-level)的任务上，如语义分割、目标检测和实例分割等。DenseCLIP通过微调一个图像解码器(Image-Decoder)，并将视觉的特征经过一个变换器(transformer)注入到文本特征中，并将视觉特征和文本特征进行比对，得到一个像素-文本匹配得分图(pixel-text score map)。然后将这个得分图输入到图像解码器做下游像素级别的任务，并使用对应的损失函数(loss)来进行训练。</p>
<p><img src="https://img2023.cnblogs.com/blog/3183309/202309/3183309-20230920150417845-1803285538.png" alt="img"></p>
<p>DenseCLIP还提出了一个预提示(pre-prompt)的方式，直接将视觉特征融合到提示(prompt)中，然后通过文本编码器(text encoder)生成类别嵌入(class embedding)。</p>
<p><img src="https://img2023.cnblogs.com/blog/3183309/202309/3183309-20230920151111810-2009146346.png" alt="img"></p>
<p>DenseCLIP将CLIP prompt应用到了像素相关的任务上，证明了prompt在密集预测任务上的巨大潜力。CLIP之所以很难用于密集的预测任务，这主要是因为CLIP的训练都是在实例级别(instance-level)，无论是图片还是文本都是实例级别的粗粒度(granularity)。但是DenseCLIP在整个CLIP中只固定text encoder，需要训练image encoder和设计的image decoder；这其实需要更多的数据来进行训练。此外，DenseCLIP还需要设计合适的提示(prompt)，以及考虑如何平衡提示和视觉特征之间的权重。</p>
<p><a href="https://github.com/j-min/VL-T5">Code</a></p>
<p><strong>统一的Prompt</strong>:在视觉和语言的任务中，通常需要为每一个下游任务设计特定的模型结构和目标函数，例如，为了解决视觉问答（VQA）问题，需要构建一个多标签分类器，为了解决指代表达理解（Referring Expression Comprehension, REC）问题，需要构建一个区域打分器，为了解决图像描述（Image Captioning）问题，需要构建一个语言生成器，等等。这些方法不仅增加了模型的复杂度和开发成本，而且也限制了模型在不同任务之间共享和迁移知识的能力。为了克服这些困难，这篇论文[^7]提出了一个统一的框架，基于编码器-解码器（Encoder-Decoder）模型，使用相同的语言建模目标，即多模态条件文本生成（Multimodal Conditional Text Generation），来学习不同的视觉和语言任务。该框架可以同时处理VQA、REC、视觉常识推理（Visual Commonsense Reasoning, VCR）等7个下游任务，并且只需要在输入和输出上进行简单的适配。本文的主要贡献是将多种视觉和语言任务统一为文本生成问题，并且证明了这种方法在性能和泛化能力上与最先进的任务特定模型相当。</p>
<p><img src="https://img2023.cnblogs.com/blog/3183309/202309/3183309-20230921221852819-2013745469.png" alt="img"></p>
<p>对于模型的输入输出设计，本文采用了类似于T5的方法，即在输入序列的开头添加一个表示任务类型的token，如<code>&lt;VQA&gt;</code>、<code>&lt;REC&gt;</code>等，并且使用特殊的token来标记文本和图像中被遮盖（mask）的部分，如<code>&lt;vis1&gt;</code>、<code>&lt;text1&gt;</code>等。这些token可以帮助模型区分不同的输入模态和任务需求，并且可以通过预训练和微调来学习它们的语义。对于输出序列，本文根据不同任务的输出格式来生成相应的文本标签。例如，对于REC任务，输出序列会是<code>&lt;vis1&gt;</code>表示被指代的区域；对于VQA任务，输出序列会是一个或多个单词表示答案；对于图像描述任务，输出序列会是一个完整的句子描述图像内容。</p>
<p><a href="https://github.com/OFA-Sys/OFA">OFA Code</a></p>
<p>在深度学习领域，不同的任务和模态通常需要不同的模型架构和训练方法，这导致了大量的工程复杂度和资源浪费。为了解决这个问题，一些研究者尝试设计一个统一的框架，可以同时处理多种任务和模态，而无需对每个任务进行专门的定制。这样的框架通常基于prompt的思想，即将任务的输入和输出都表示为token序列，并使用一个具有足够容量的预训练模型来生成或预测输出序列，然而之前很少有研究在多个不同下游任务的数据集上训练一个模型，大部分都是基于预训练模型进行prefix-tune或者prompt。</p>
<p>2022年，阿里达摩院的王鹏等人提出了一个名为OFA（one for all）的框架[^10]，它是目前最先进的多模态预训练框架之一。虽然OFA并不是在已有的预训练模型上进行研究工作的，但它也可以看作是一种prompt的工作，因为它将所有的下游任务都建模为seq2seq任务，并使用一个统一的模型来处理不同的输入和输出。OFA支持多种跨模态和单模态的任务，包括图像生成、视觉定位、图像描述、图像分类、语言建模等。OFA遵循基于指令的学习，在预训练和微调阶段都不需要额外的任务特定层。例如，实体检测的输出会被转化为<code>&lt;loc x1&gt;,&lt;loc x2&gt;...</code>，而对于模型内部使用的backbone仍然是老一套的transformer和resnet。OFA只使用了2000万公开可用的图像-文本对进行预训练，但在一系列跨模态任务上达到了新的SOTA水平，在单模态任务上也表现出了高度竞争力。OFA还能有效地迁移到未见过的任务和领域。</p>
<p><img src="https://img2023.cnblogs.com/blog/3183309/202309/3183309-20230921222651396-1522268963.png" alt="img"></p>
<p><strong>LM-&gt;MultiModel</strong>(代码未开源):多模态任务通常需要一个预训练的多模态模型来进行微调或适应，但是这篇论文[^8]提出了一种利用语言模型（language model, LM）来进行提示（prompt）的方法，从而实现多模态的少样本学习（few-shot learning）。它的思想是用一个图像编码器（image encoder）将图像转换为一系列的连续嵌入（continuous embeddings），作为LM的输入前缀（prefix），与文本一起送入LM中，从而激活LM中的先验知识（prior knowledge）。为了避免LM在多模态领域过拟合或遗忘，作者选择在训练时固定LM的参数（frozen），只优化图像编码器相关的参数。图像前缀的构造方式如下图所示：将图像编码器的输出映射为D*n的矩阵，其中D为嵌入维度，n为嵌入的token数量。</p>
<p><img src="https://img2023.cnblogs.com/blog/3183309/202309/3183309-20230920231511586-192977427.png" alt="img"></p>
<p>由于该方法只使用少量或零样本（zero-shot）来进行多模态任务，因此不能对LM进行微调（fine-tuning），否则会导致LM产生灾难性遗忘（catastrophic forgetting）。该方法的优点是模型结构简单，训练过程容易，并且不需要微调LM，因此是一个轻量级的提示工作。但是它的性能也比较一般，达不到最先进（state-of-the-art, SOTA）的水平。</p>
<p><img src="https://img2023.cnblogs.com/blog/3183309/202309/3183309-20230920231511586-192977427.png" alt="img"></p>
<p>需要注意的是，由于few-shot或者zero-shot的样本数量较少，所以该模型不能够对LM进行微调，LM的参数是固定的，只优化图像编码器的参数。否则就是使得LM产生灾难性遗忘。本文的模型较为简单，训练也十分容易，并且不用微调LM，因此是一个轻量级的prompt工作，他的性能也比较一般，达不到sota的水平。</p>
<p><a href="https://github.com/thunlp/CPT">CPT Code</a>
<strong>visual grounding</strong>:CPT[^2]是一种基于预训练视觉-语言模型 (VL-PTMs) 的跨模态Prompt-Tuning方法，它利用颜色作为图像和文本之间的共指标记，将视觉基础问题转化为填空问题。具体来说，它将输入图片中的物体替换为不同的颜色，并在文本描述中添加相应颜色的mask作为提示。例如，对于图片中的“黄色人”，它会生成“[MASK] person”作为文本提示，并要求模型预测出正确的颜色。这样做可以最大程度地缩小预训练和微调之间的目标形式差距，从而提高VL-PTMs在视觉基础任务上的泛化能力。这种方法与手工设计的prompt有些相似，因为它不涉及任何参数更新，只依赖于模型对文本和视觉特征之间关系的理解。</p>
<p>CPT是一种非常轻量级和灵活的prompt方法，几乎可以看作是手工设计的prompt的一种自动化版本。它在多种视觉基础任务上都取得了优异的性能，包括实体检测、场景图分类、视觉常识推理等。与传统的微调方法相比，CPT不需要大量标注数据或计算资源，甚至可以在零样本或少样本条件下实现有效的视觉基础。CPT背后的思想其实就是利用prompt将视觉基础问题转化为模型内部已经掌握的选择题问题，从而激发出VL-PTMs潜在的跨模态能力。</p>
<p><img src="https://img2023.cnblogs.com/blog/3183309/202309/3183309-20230921185213511-1585589343.png" alt="img"></p>
<h2 id="参考文献">参考文献</h2>
<p>[^1]:《Pre-train, Prompt, and Predict: A Systematic Survey of Prompting Methods in Natural Language Processing》
[^2]:CPT: Colorful Prompt Tuning for Pre-trained Vision-Language Models
[^3]:CLIP: Learning Transferable Visual Models From Natural Language Supervision.
[^4]:CoOp: Learning to Prompt for vision-language models CVPR 2021.9
[^5]:DenseCLIP: Language-Guided Dense Prediction with Context-Aware Prompting (2021.12)
[^6]:CoCoOp: Conditional Prompt Learning for Vision-Language Models CVPR 2022
[^7]:Unifying Vision-and-Language Tasks via Text Generation ICML 2021
[^8]:Multimodal Few-Shot Learning with Frozen Language Models NIPS 2021
[^9]:
[^10]:Unifying Architectures,Tasks,and Modalities Through a Simple Sequence-to-Sequence Learning Framework 2022</p>

        <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
        <script async type="text/javascript">
/* From extension cnblogs.vscode-cnb */
(()=>{"use strict";var e={};(e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})})(e);var t,n=function(e){for(var t,n=0,r=null!==(t=Array.from(e.classList).filter((function(e){return e.toLowerCase().endsWith("sql")})))&&void 0!==t?t:[];n<r.length;n++){var i=r[n];e.classList.remove(i),e.classList.add("language-sql")}},r=function(e,t){null==t||t.forEach((function(t){return e.setAttribute(t.name,t.value)}))},i={enableCodeLineNumber:!0,prism:{scriptPath:"/prism.min.js",autoLoaderPluginPath:"",lineNumberPluginPath:"",stylesheets:[],themeBaseUrl:"",defaultTheme:""},hljs:{scriptPath:"/highlight.min.js",lineNumberPluginPath:"/highlightjs-line-numbers.min.js",stylesheets:[],themeBaseUrl:"",defaultTheme:""}},o={enableCodeLineNumber:!1,prism:{scriptPath:"https://common.cnblogs.com/prism/prism.js?v=1.23.0",lineNumberPluginPath:"https://common.cnblogs.com/prism/plugins/line-numbers/prism-line-numbers.min.js",autoLoaderPluginPath:"https://common.cnblogs.com/prism/plugins/autoloader/prism-autoloader.min.js",lineNumberStylePath:"https://common.cnblogs.com/prism/plugins/line-numbers/prism-line-numbers.css",themeBaseUrl:"https://www.cnblogs.com/css/prismjs",defaultTheme:"prism-vs",stylesheets:[]},hljs:{scriptPath:"https://common.cnblogs.com/highlight/11.4.0/highlight.min.js",lineNumberPluginPath:"https://common.cnblogs.com/scripts/highlightjs-line-numbers.min.js",stylesheets:[],themeBaseUrl:"https://www.cnblogs.com/css/hljs",defaultTheme:"cnblogs"}};!function(e){var t=Object.assign({},i);e.set=function(e){Object.assign(t,e)},e.get=function(){return t}}(t||(t={}));var s,l=[],a=function(e){e&&clearTimeout(e)},u=function(e,t){var n=l.findIndex((function(n){return e&&n[0]===e||n[0]===t}));n>=0&&l.splice(n,1)},c=function(e){var t,n,r=e.url,i=e.id,o=e.timeoutSeconds,s=e.appendTo,c=e.hostElementTagName,h=e.beforeElementCreateCallback,f=s?s.ownerDocument:document,p=null!==(n=null!==(t=f.defaultView)&&void 0!==t?t:f.parentWindow)&&void 0!==n?n:window,d=function(e,t){var n=l.find((function(n){return e&&n[0]===e||n[0]===t}));return(null!=n?n:[])[1]}(f!==document?"load-resource-to-another-window-context-"+p.name+"-"+i:i,r);if(d)return d;var m=f.querySelector("".concat(c,"#").concat(i));return(m=(m=m||"script"===c&&f.querySelector('script[src="'.concat(r,'"]')))||"link"===c&&f.querySelector('link[href="'.concat(r,'"]')))?Promise.resolve(m):(d=new Promise((function(e,t){var n,l;n=c,l=function(n){var l;n.id=null!=i?i:"",null!=s||(s=f.head),o=o<=0?5:o,n instanceof HTMLLinkElement?(n.href=r,n.rel="stylesheet",n.type="text/css"):n instanceof HTMLScriptElement&&(n.src=r,n.type="text/javascript",n.defer=!0),n.onload=function(){a(l),u(i,r),e(n)},n.onerror=function(e){a(l),n.remove(),u(i,r),t(e)},null==h||h.call(void 0,n),s.append(n),l=setTimeout((function(){a(l),n.remove(),u(i,r),t("timeout after ".concat(o," seconds"))}),1e3*o)},l(document.createElement(n))})),l.push([i||r,d]),d)},h={},f=function(){return h},p=function(e){var t,n=e.src,r=e.id,i=e.timeoutSeconds,o=e.appendTo,s=e.executionStrategy;return c({url:n,hostElementTagName:"script",timeoutSeconds:null!==(t=null!=i?i:f().timeoutSeconds)&&void 0!==t?t:5,id:r,appendTo:null!=o?o:f().appendTo,beforeElementCreateCallback:function(e){e instanceof HTMLScriptElement&&("async"===(null!=s?s:f().executionStrategy)?(e.async=!0,e.defer=!1):(e.defer=!0,e.async=!1))}})},d=function(e){var t,n=e.href,r=e.timeoutSeconds,i=e.id,o=e.appendTo;return c({url:n,hostElementTagName:"link",timeoutSeconds:null!==(t=null!=r?r:f().timeoutSeconds)&&void 0!==t?t:5,id:i,appendTo:null!=o?o:f().appendTo})},m="highlighted-line",g="highlighter-prismjs",b=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{a(r.next(e))}catch(e){o(e)}}function l(e){try{a(r.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,l)}a((r=r.apply(e,t||[])).next())}))},y=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(o){return function(l){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}},v=function(){function e(){this._isDarkTheme=!1,this.removeLinkElements("link[rel=stylesheet][prismjs]"),this.removeLinkElements("link[rel=stylesheet][hljs]")}return Object.defineProperty(e.prototype,"enableCodeLineNumber",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"adapterOptions",{get:function(){return t.get()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isDarkTheme",{get:function(){return this._isDarkTheme},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"linesHighlightedClassToken",{get:function(){return this.id+"-lines-highlighted"},enumerable:!1,configurable:!0}),e.prototype.highlightAllUnder=function(e,t,n){return b(this,void 0,void 0,(function(){var r,i,o,s,l,a,u,c=this;return y(this,(function(h){switch(h.label){case 0:return(r="string"==typeof e?document.querySelector(e):e)?(i=Array.from(r.querySelectorAll("pre code")).map((function(e){return e}))).length>0?[4,this.ensureResourcesLoaded()]:[3,2]:[2];case 1:h.sent(),h.label=2;case 2:for(o=[],s=function(e){var r=e.parentElement,i=e;if(t&&!t(r,i))return"continue";o.push(new Promise((function(e,t){c.highlight(i).then((function(){n&&n(r,i),e()}),(function(){return t()}))})))},l=0,a=i;l<a.length;l++)u=a[l],s(u);return[4,Promise.all(o)];case 3:return h.sent(),[2]}}))}))},e.prototype.setTheme=function(e,t,n){var i;return b(this,void 0,void 0,(function(){var o,s;return y(this,(function(l){switch(l.label){case 0:if(this.setIsDarkTheme(n),!e&&!this.highlighterOptions.defaultTheme)throw Error("Theme is required! And default theme not configured!");return e||(e=this.highlighterOptions.defaultTheme),o="highlighter-theme-".concat(e),s=!1,null===(i=document.querySelectorAll("link[id*=highlighter-theme-],link[id*=line-numbers-style]"))||void 0===i||i.forEach((function(e){e.id!==o?e.remove():s=!0})),s?[2]:(this._themeHref="".concat(this.highlighterOptions.themeBaseUrl,"/").concat(e,".css"),[4,d({href:this._themeHref,id:o,beforeElementCreateCallback:function(e){return r(e,t)}})]);case 1:return l.sent(),[2]}}))}))},e.prototype.resolveContainerElements=function(e){var t=null,n=null;if(e instanceof HTMLPreElement?(t=e,n=e.querySelector("code")):"code"===e.tagName.toLowerCase()&&e.parentElement instanceof HTMLPreElement&&(t=e.parentElement,n=e),n&&t)return[t,n]},e.prototype.loadStyles=function(e){var t;return b(this,void 0,void 0,(function(){var n,i,o,s,l;return y(this,(function(a){switch(a.label){case 0:for(n=null!==(t=this.highlighterOptions.stylesheets)&&void 0!==t?t:[],i=[],o=0,s=n;o<s.length;o++)l=s[o],i.push(d({href:l.href,id:l.tagId,beforeElementCreateCallback:function(t){return r(t,e)}}));return[4,Promise.all(i)];case 1:return a.sent(),[2]}}))}))},e.prototype.tryApplyLang=function(e){var t,n,r,i,o,s;if(!e)return"";var l=Array.from(e.classList),a=null!==(r=null===(n=null===(t=e.parentElement)||void 0===t?void 0:t.tagName)||void 0===n?void 0:n.toLowerCase())&&void 0!==r?r:"";if(l.findIndex((function(e){return e.startsWith("language-")}))<0&&"pre"===a){var u=Array.from(null!==(o=null===(i=e.parentElement)||void 0===i?void 0:i.classList)&&void 0!==o?o:[]).find((function(e){return e.startsWith("language-")}));u&&e.classList.add(u)}return null!==(s=Array.from(e.classList).find((function(e){return e.startsWith("language-")})))&&void 0!==s?s:""},e.prototype.setBodyClass=function(e){var t=["prismjs-engine","hljs-engine"],n=window.document.body.classList;switch(n.remove.apply(n,t),e){case"prismjs":n.add(t[0]);break;case"highlight.js":n.add(t[1])}},e.prototype.setEngineClassToken=function(e,t){for(var n=[g,"highlighter-hljs"],r=t.querySelector("code"),i=0,o=[null==r?void 0:r.classList,t.classList];i<o.length;i++){var s=o[i];switch(null==s||s.remove.apply(s,n),e){case"prismjs":null==s||s.add(n[0]);break;case"highlight.js":null==s||s.add(n[1])}}},e.prototype.removeLinesHighlightedClassToken=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=0,r=e;n<r.length;n++){var i=r[n].classList;i.remove.apply(i,Array.from(i).filter((function(e){return e.endsWith("-lines-highlighted")})))}},e.prototype.filterCodeContent=function(e){var t,n;if(!e)return"";var r=document.createElement("code");if(r.style.opacity="0",r.style.width="0",r.style.height="0",r.style.whiteSpace="pre","code"===e.tagName.toLowerCase())r.innerHTML=e.innerHTML;else{if("pre"!==e.tagName.toLowerCase()||!e.querySelector("code"))return"";r.innerHTML=null!==(n=null===(t=e.querySelector("code"))||void 0===t?void 0:t.innerHTML)&&void 0!==n?n:""}var i=r.querySelector(".line-numbers-rows");i&&i.remove();var o=r.querySelectorAll(".hljs-ln-line.hljs-ln-numbers");null==o||o.forEach((function(e){return e.remove()})),document.body.append(r);var s,l,a=r.innerText;return r.remove(),e.innerHTML=(s=a,(l=document.createElement("div")).textContent=s,l.innerHTML),a},e.prototype.removeLinkElements=function(e){var t;null===(t=document.querySelectorAll(e))||void 0===t||t.forEach((function(e){return e.remove()}))},e.prototype.resolveLinesToHighlight=function(e){var t=e.getAttribute("data-lines-highlight");try{var n=JSON.parse(null!=t?t:"[]");return Array.isArray(n)?n.map((function(e){return e-1})):[]}catch(e){return void console.warn(e)}},e.prototype.setIsDarkTheme=function(e){this._isDarkTheme=null!=e&&e},e}(),w={tcltk:"tcl",tclsh:"tcl",tk:"tcl",pq:"powerquery",mscript:"powerquery",M:"powerquery",wat:"wasm",wast:"wasm",webassembly:"wasm"};!function(e){var t=this,n=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return hljs.getLanguage(e)?(hljs.registerAliases(t.filter((function(e){return null==hljs.getLanguage(e)})),{languageName:e}),!0):(console.warn("Try to register [".concat(t.join(","),"] as aliases of ").concat(e,", but ").concat(e," is not defined.")),!1)};e.load=function(e,r){return i=t,o=void 0,l=function(){var t,i,o,s,l,a;return function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(o){return function(l){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}}(this,(function(u){switch(u.label){case 0:if(e=e.toLowerCase().trim().replace("language-",""),!(t=null!==(a=w[e])&&void 0!==a?a:e)||hljs.getLanguage(t))return n(t,e),[2];i=r.scriptPath,(o=i.split("/")).pop(),s=o.join("/")+"/languages/".concat(t,".min.js"),u.label=1;case 1:return u.trys.push([1,3,,4]),[4,p({id:"hljs-language-".concat(t),src:s})];case 2:return u.sent(),n(t,e),[3,4];case 3:return l=u.sent(),console.warn("加载hljs语言定义脚本失败",l),[3,4];case 4:return[2]}}))},new((s=void 0)||(s=Promise))((function(e,t){function n(e){try{a(l.next(e))}catch(e){t(e)}}function r(e){try{a(l.throw(e))}catch(e){t(e)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(e){e(i)}))).then(n,r)}a((l=l.apply(i,o||[])).next())}));var i,o,s,l}}(s||(s={}));var L,j=(L=function(e,t){return L=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},L(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}L(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),P=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{a(r.next(e))}catch(e){o(e)}}function l(e){try{a(r.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,l)}a((r=r.apply(e,t||[])).next())}))},T=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(o){return function(l){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}},k=window,C=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._linkAttr={name:"hljs",value:""},t}return j(t,e),Object.defineProperty(t.prototype,"highlighterOptions",{get:function(){return this.adapterOptions.hljs},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return"highlight.js"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"linesHighlightedClassToken",{get:function(){return"hljs-lines-highlighted"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"enableCodeLineNumber",{get:function(){return this.adapterOptions.enableCodeLineNumber},enumerable:!1,configurable:!0}),t.prototype.ensureResourcesLoaded=function(){return P(this,void 0,void 0,(function(){var e;return T(this,(function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),[4,this.loadHljs()];case 1:return t.sent(),[4,this.loadStyles([this._linkAttr])];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),console.error(e),[2];case 4:return[2]}}))}))},t.prototype.highlight=function(e){var t;return P(this,void 0,void 0,(function(){var r,i,o,l,a,u;return T(this,(function(c){switch(c.label){case 0:return[4,this.ensureResourcesLoaded()];case 1:if(c.sent(),r=this.enableCodeLineNumber,i=null!==(t=this.resolveContainerElements(e))&&void 0!==t?t:[],o=i[0],l=i[1],!o||!l)return[2];o.classList.remove(g),c.label=2;case 2:return c.trys.push([2,5,,6]),r?[4,this.loadLineNumberPlugin()]:[3,4];case 3:c.sent(),c.label=4;case 4:return[3,6];case 5:return a=c.sent(),console.error(a),[3,6];case 6:return this.setBodyClass("highlight.js"),this.setEngineClassToken(this.id,o),this.removeLinesHighlightedClassToken(o,l),e.classList.remove("hljs-line-numbers"),u=this.tryApplyLang(e),this.filterCodeContent(e),n(e),[4,s.load(u,this.highlighterOptions)];case 7:return c.sent(),hljs.highlightElement(e),r&&(hljs.lineNumbersValue?(e.innerHTML=hljs.lineNumbersValue(e.innerHTML,{singleLine:!0}),e.classList.add("hljs-line-numbers")):console.error("failed to load hljs line numbers plugin!")),this.highlightLines(o),l.classList.add("hljs"),this.isDarkTheme?e.setAttribute("data-dark-theme","true"):e.removeAttribute("data-dark-theme"),[2]}}))}))},t.prototype.highlightLines=function(e){var t=e.querySelector("code");if(!t)return[];var n=this.resolveLinesToHighlight(t);if(null==n||n.length<=0)return[];var r=t.innerHTML;if(!1===this.adapterOptions.enableCodeLineNumber){for(var i=r.split("\n"),o=0,s=n;o<s.length;o++)if(!((c=s[o])<0||c>=i.length)){var l=i[c];null!=l&&(i[c]='<span class="'.concat(m,'">').concat(l,"</span>"))}t.innerHTML='<span class="hljs-lines-highlight-wrapper">'.concat(i.join("\n"),"</span>")}else{i=Array.from(t.querySelectorAll("tr"));for(var a=0,u=n;a<u.length;a++){var c;if(!((c=u[a])<0||c>=i.length)){var h=i[c];h&&h.classList.add(m)}}}return e.classList.add(this.linesHighlightedClassToken),null!=n?n:[]},t.prototype.loadHljs=function(){return P(this,void 0,void 0,(function(){var e;return T(this,(function(t){switch(t.label){case 0:return e=this.adapterOptions.hljs.scriptPath,k.hljs?[3,2]:[4,p({id:"hljs-script",src:e})];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},t.prototype.loadLineNumberPlugin=function(){return P(this,void 0,void 0,(function(){var e;return T(this,(function(t){switch(t.label){case 0:return e=this.adapterOptions.hljs.lineNumberPluginPath,[4,p({id:"hljs-line-numbers",src:e})];case 1:return t.sent(),[2]}}))}))},t}(v),S=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),O=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{a(r.next(e))}catch(e){o(e)}}function l(e){try{a(r.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,l)}a((r=r.apply(e,t||[])).next())}))},E=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(o){return function(l){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}},H=window,N=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._linkAttr={name:"prismjs",value:""},t}return S(t,e),Object.defineProperty(t.prototype,"highlighterOptions",{get:function(){return this.adapterOptions.prism},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return"prismjs"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"enableCodeLineNumber",{get:function(){return this.adapterOptions.enableCodeLineNumber},enumerable:!1,configurable:!0}),t.prototype.highlight=function(e){var t;return O(this,void 0,void 0,(function(){var r,i,o;return E(this,(function(s){switch(s.label){case 0:return[4,this.ensureResourcesLoaded()];case 1:return s.sent(),r=null!==(t=this.resolveContainerElements(e))&&void 0!==t?t:[],i=r[0],o=r[1],i&&o?(this.adapterOptions.enableCodeLineNumber?i.classList.add("line-numbers"):(i.classList.remove("line-numbers"),o.classList.remove("line-numbers")),this.tryApplyLang(o),this.setBodyClass("prismjs"),this.setEngineClassToken(this.id,i),this.removeLinesHighlightedClassToken(i),this.filterCodeContent(o),n(o),Prism.highlightElement(o,!1),this.highlightLines(i),[2]):[2]}}))}))},t.prototype.highlightLines=function(e){var t,n,r=e.querySelector("code"),i=this.resolveLinesToHighlight(r)||this.resolveLinesToHighlight(e);if(!i)return[];var o=r.innerHTML,s=null!==(n=null===(t=r.querySelector(".line-numbers-rows"))||void 0===t?void 0:t.outerHTML)&&void 0!==n?n:"";s&&(o=o.replace(s,""));var l=o.split("\n");return i.forEach((function(e){if(!(e<0||e>=l.length)){var t=l[e];l[e]='<span class="'.concat(m,'">').concat(t,"</span>")}})),r.innerHTML=l.join("\n")+s,e.classList.add(this.linesHighlightedClassToken),i},t.prototype.ensureResourcesLoaded=function(){return O(this,void 0,void 0,(function(){var e;return E(this,(function(t){switch(t.label){case 0:return t.trys.push([0,4,,5]),[4,this.loadPrismAsync()];case 1:return t.sent(),[4,Promise.all([this.loadPrismAutoLoader(),this.loadPrismLineNumberPluginScript()])];case 2:return t.sent(),[4,this.loadStyles([this._linkAttr])];case 3:return t.sent(),[3,5];case 4:return e=t.sent(),console.error(e),[2];case 5:return[2]}}))}))},t.prototype.setTheme=function(t,n,r){return O(this,void 0,void 0,(function(){return E(this,(function(i){switch(i.label){case 0:return[4,e.prototype.setTheme.call(this,t,n,r)];case 1:return i.sent(),[4,this.loadPrismLineNumberPluginStyle()];case 2:return i.sent(),[2]}}))}))},t.prototype.loadPrismAsync=function(){return O(this,void 0,void 0,(function(){var e;return E(this,(function(t){switch(t.label){case 0:return H.Prism=H.Prism||{},Prism.manual=!0,e=this.adapterOptions.prism.scriptPath,[4,p({id:"prismjs-script",src:e})];case 1:return t.sent(),[2]}}))}))},t.prototype.loadPrismAutoLoader=function(){var e;return O(this,void 0,void 0,(function(){var t,n;return E(this,(function(r){switch(r.label){case 0:return t=!!(null===(e=H.Prism.plugins)||void 0===e?void 0:e.autoloader),n=this.adapterOptions.prism.autoLoaderPluginPath,t?[3,2]:[4,p({id:"prismjs-autoloader-script",src:n})];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))},t.prototype.loadPrismLineNumberPluginScript=function(){return O(this,void 0,void 0,(function(){return E(this,(function(e){switch(e.label){case 0:if(!this.enableCodeLineNumber)return[2];if(!this.adapterOptions.prism.lineNumberPluginPath)throw Error("lineNumberPluginPath not configured");return[4,p({id:"prism-line-numbers-script",src:this.adapterOptions.prism.lineNumberPluginPath})];case 1:return e.sent(),[2]}}))}))},t.prototype.loadPrismLineNumberPluginStyle=function(){return O(this,void 0,void 0,(function(){return E(this,(function(e){if(!this.enableCodeLineNumber)return[2];if(!this.adapterOptions.prism.lineNumberStylePath)throw Error("lineNumberStylePath not configured");return d({id:"prism-line-numbers-style",href:this.adapterOptions.prism.lineNumberStylePath,beforeElementCreateCallback:function(e){return r(e,[{name:"prismjs",value:""}])}}).then(),[2]}))}))},t}(v);function A(){const e="highlightedLineBackground";if(null===document.querySelector(`#${e}`)){const t=document.createElement("style");t.id=e,t.innerHTML=":root { --highlighted-line-bg: var(--vscode-diffEditor-insertedTextBackground) }",document.head.append(t)}const t=new C;document.querySelectorAll('pre[class*="language-"][data-lines-highlight]').forEach((e=>{const n=e.querySelector("code");null!==n&&(n.firstChild instanceof HTMLDivElement&&1===n.children.length&&(n.firstChild.outerHTML=n.firstChild.innerHTML),t.highlightLines(e))}))}(function(){function e(){}return e.configCodeHighlightOptions=function(e){t.set(e)},e.useCnblogsCodeHighlightOptions=function(){this.configCodeHighlightOptions(o)},e.createCodeHighlighter=function(e,t,n){var r;switch(n&&this.configCodeHighlightOptions(n),e){case"highlight.js":r=new C;break;case"prismjs":r=new N;break;default:throw Error("unknown highlight engine")}t||(t=r.highlighterOptions.defaultTheme);var i="string"==typeof t?t:t.name,o="string"!=typeof t&&t.isDark;return r.setTheme(i,void 0,o).then(),r},e})().configCodeHighlightOptions({enableCodeLineNumber:!1}),window.addEventListener("vscode.markdown.updateContent",A),A(),module.exports=e})();
</script>

    </body>
    </html>